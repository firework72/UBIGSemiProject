<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="adoptionMapper">

	<!-- 동물 등록하기 -->
	<insert id="insertAnimal" parameterType="AnimalDetail">
        INSERT INTO ANIMAL_DETAILS (
            ANIMAL_NO,
            SPECIES,
            ANIMAL_NAME,
            BREED,
            GENDER,
            AGE,
            WEIGHT,
            PET_SIZE,
            NEUTERED,
            VACCINATION_STATUS,
            HEALTH_NOTES,
            ADOPTION_STATUS,
            ADOPTION_CONDITIONS,
            HOPE_REGION,
            DEADLINE_DATE,
            PHOTO_URL,
            USER_ID
        ) VALUES (
            SEQ_ANIMAL_DETAILS.NEXTVAL,
            #{species},
            #{animalName},
            #{breed},
            #{gender},
            #{age},
            #{weight},
            #{petSize},
            #{neutered},
            #{vaccinationStatus},
            #{healthNotes},
            #{adoptionStatus},
            #{adoptionConditions},
            #{hopeRegion},
            #{deadlineDate},
            #{photoUrl},
            #{userId}
		)
    </insert>
	
	<!-- 동물 정보 수정 -->
	<update id="updateAnimal" parameterType="AnimalDetail">
		UPDATE ANIMAL_DETAILS
		SET
			SPECIES = #{species},
			ANIMAL_NAME = #{animalName},
			BREED = #{breed},
			GENDER = #{gender},
			AGE = #{age},
			WEIGHT = #{weight},
			PET_SIZE = #{petSize},
			NEUTERED = #{neutered},
			VACCINATION_STATUS = #{vaccinationStatus},
			HEALTH_NOTES = #{healthNotes},
			ADOPTION_STATUS = #{adoptionStatus},
			ADOPTION_CONDITIONS = #{adoptionConditions},
			HOPE_REGION = #{hopeRegion},
			DEADLINE_DATE = #{deadlineDate},
			PHOTO_URL = #{photoUrl}
		WHERE ANIMAL_NO = #{animalNo}
	</update>

    <!-- 입양 신청 상태 변경  -->
    <update id="updateAdoptionStatus" parameterType="map">
    	UPDATE ANIMAL_DETAILS
    	SET ADOPTION_STATUS = #{status}
    	WHERE ANIMAL_NO = #{animalNo}
    </update>
    
    <!-- 리스트 갯수 세기 (게시글 기준, 검색 필터 적용) -->
    <select id="listCount" resultType="_int" parameterType="com.ubig.app.vo.adoption.AdoptionSearchFilterVO">
    	SELECT count(*)
    	FROM ADOPTION_POSTS P
    	JOIN ANIMAL_DETAILS A ON P.ANIMAL_NO = A.ANIMAL_NO
    	<where>
    		<if test="species != null">
    			AND A.SPECIES = #{species}
    		</if>
    		<if test="gender != null">
    			AND A.GENDER = #{gender}
    		</if>
    		<if test="neutered != null">
    			AND A.NEUTERED = #{neutered}
    		</if>
    		<if test="ageMin != null">AND A.AGE &gt;= #{ageMin}</if>
    		<if test="ageMax != null">AND A.AGE &lt;= #{ageMax}</if>
    		<if test="weightMin != null">AND A.WEIGHT &gt;= #{weightMin}</if>
    		<if test="weightMax != null">AND A.WEIGHT &lt;= #{weightMax}</if>
    		<if test="breed != null and breed != ''">AND A.BREED LIKE '%' || #{breed} || '%'</if>
    		<if test="hopeRegion != null and hopeRegion != ''">AND A.HOPE_REGION LIKE '%' || #{hopeRegion} || '%'</if>
    		<if test="keyword != null and keyword != ''">AND A.ANIMAL_NAME LIKE '%' || #{keyword} || '%'</if>
    	</where>
    </select>
    
    <!-- 페이징 처리용 게시글 (JOIN, 검색 필터 적용) -->
    <select id="selectAdoptionMainList" resultType="com.ubig.app.vo.adoption.AdoptionMainListVO" parameterType="com.ubig.app.vo.adoption.AdoptionSearchFilterVO">
        SELECT 
            P.POST_NO,
            P.POST_TITLE,
            P.POST_UPDATE_DATE,
            P.VIEWS,
            P.ANIMAL_NO,
            A.PHOTO_URL,
            A.ANIMAL_NAME,
            A.ADOPTION_STATUS,
            A.AGE AS ANIMAL_AGE,
            A.GENDER AS ANIMAL_GENDER,
            A.WEIGHT AS ANIMAL_WEIGHT,
            A.HOPE_REGION
        FROM ADOPTION_POSTS P
        JOIN ANIMAL_DETAILS A ON P.ANIMAL_NO = A.ANIMAL_NO
    	<where>
    		<if test="species != null">
    			AND A.SPECIES = #{species}
    		</if>
    		<if test="gender != null">
    			AND A.GENDER = #{gender}
    		</if>
    		<if test="neutered != null">
    			AND A.NEUTERED = #{neutered}
    		</if>
    		<if test="ageMin != null">AND A.AGE &gt;= #{ageMin}</if>
    		<if test="ageMax != null">AND A.AGE &lt;= #{ageMax}</if>
    		<if test="weightMin != null">AND A.WEIGHT &gt;= #{weightMin}</if>
    		<if test="weightMax != null">AND A.WEIGHT &lt;= #{weightMax}</if>
    		<if test="breed != null and breed != ''">AND A.BREED LIKE '%' || #{breed} || '%'</if>
    		<if test="hopeRegion != null and hopeRegion != ''">AND A.HOPE_REGION LIKE '%' || #{hopeRegion} || '%'</if>
    		<if test="keyword != null and keyword != ''">AND A.ANIMAL_NAME LIKE '%' || #{keyword} || '%'</if>
    	</where>
        ORDER BY 
			CASE
				WHEN A.ADOPTION_STATUS = '대기중' THEN 1
				WHEN A.ADOPTION_STATUS = '신청중' THEN 2
				WHEN A.ADOPTION_STATUS = '입양완료' THEN 3
				ELSE 4
			END ASC,
			P.POST_REG_DATE DESC
    </select>
    
    <!-- 페이징 처리용 동물 -->
    <select id="getPhoto" parameterType="java.util.List" resultType="AnimalDetail">
	    SELECT ANIMAL_NO,PHOTO_URL
	    FROM ANIMAL_DETAILS
	    WHERE ANIMAL_NO IN
	    <foreach collection="list" item="item" open="(" close=")" separator=",">
	        #{item}
	    </foreach>
	</select>
	
	<!-- 보드 등록 -->
	<insert id="insertBoard" parameterType="AdoptionPostVO">
		INSERT INTO ADOPTION_POSTS(
									POST_NO,
									ANIMAL_NO,
									USER_ID,
									POST_TITLE,
									POST_REG_DATE,
									POST_UPDATE_DATE,
									VIEWS
									)
							VALUES(
									SEQ_ADOPTION_POSTS.NEXTVAL,
									#{animalNo},
									#{userId},
									#{postTitle},
									SYSDATE,
									SYSDATE,
									#{views}
							)
	</insert>
	
	<!-- 보드 삭제 -->
	<delete id="deletePost">
		DELETE
		FROM ADOPTION_POSTS
		WHERE ANIMAL_NO = #{anino}			
	</delete>
	
	<!-- 해당 동물의 입양 신청 내역 삭제 -->
	<delete id="deleteApplicationsByAnimalNo">
		DELETE
		FROM ADOPTION_APPLICATIONS
		WHERE ANIMAL_NO = #{anino}
	</delete>
	
	<!-- anino로 동물 정보 가지고 오기 -->
	<select id="goAdoptionDetail" resultType="AnimalDetail">
		SELECT *
		FROM ANIMAL_DETAILS
		WHERE ANIMAL_NO = #{anino}
	</select>
	
	<!-- 신청 정보 insert -->
	<insert id="insertApplication" parameterType="AdoptionApplicationVO">
		INSERT INTO ADOPTION_APPLICATIONS(
										ADOPTION_APP_ID,
										ANIMAL_NO,
										USER_ID,
										ADOPT_STATUS,
										APPLY_DT	
										)
								VALUES(
										SEQ_ADOPTION_APPS.NEXTVAL,
										#{animalNo},
										#{userId},
										#{adoptStatus},
										SYSDATE
								)
	</insert>
	
	<!-- 조회수 증가 -->
	<update id="updateViewCount" parameterType="int">
		UPDATE ADOPTION_POSTS
		SET VIEWS = VIEWS+1
		WHERE ANIMAL_NO = #{animalNo}
	</update>
	
	<!-- 동물 삭제 -->
	<delete id="deleteanimal" parameterType="int">
		DELETE
		FROM ANIMAL_DETAILS
		WHERE ANIMAL_NO = #{anino}
	</delete>
	
	<!-- 동물 번호로 post유무 조회 -->
	<select id="checkpost" parameterType="int" resultType="int">
		SELECT COUNT(*)
		FROM ADOPTION_POSTS
		WHERE ANIMAL_NO = #{anino}
	</select>
	

	
	<!-- 유저가 등록한 입양 정보 가지고오기 -->
	<select id="selectAnimalList1" resultType="com.ubig.app.vo.adoption.AdoptionMainListVO">
        SELECT 
            P.POST_NO,
            P.POST_TITLE,
            P.POST_UPDATE_DATE,
            TO_CHAR(P.POST_REG_DATE, 'YYYY-MM-DD') AS POST_REG_DATE,
            P.VIEWS,
            A.ANIMAL_NO,
            A.PHOTO_URL,
            A.ANIMAL_NAME,
            A.ADOPTION_STATUS
        FROM ANIMAL_DETAILS A
        LEFT JOIN ADOPTION_POSTS P ON A.ANIMAL_NO = P.ANIMAL_NO
		WHERE A.USER_ID = #{userId}
		<if test="keyword != null and keyword != ''">
			AND A.ANIMAL_NAME LIKE '%' || #{keyword} || '%'
		</if>
		ORDER BY
			CASE
				WHEN A.ADOPTION_STATUS = '대기중' THEN 1
				WHEN A.ADOPTION_STATUS = '신청중' THEN 2
				WHEN A.ADOPTION_STATUS = '입양완료' THEN 3
				ELSE 4
			END ASC,
			A.ANIMAL_NO DESC
	</select>
	
	<!-- 유저가 등록한 동물 수 세기 -->
	<select id="selectAnimalList1Count" resultType="_int">
		SELECT COUNT(*)
		FROM ANIMAL_DETAILS
		WHERE USER_ID = #{userId}
		<if test="keyword != null and keyword != ''">
			AND ANIMAL_NAME LIKE '%' || #{keyword} || '%'
		</if>
	</select>
	
	<!-- 유저가 신청한 입양 정보 가지고 오기 -->
	<select id="selectAnimalList2" resultType="AdoptionApplicationVO">
		SELECT 
            AP.ADOPTION_APP_ID,
            AP.ANIMAL_NO,
            AP.USER_ID,
            AP.ADOPT_STATUS,
            AP.APPLY_DT,
            TO_CHAR(AP.APPLY_DT, 'YYYY-MM-DD') AS APPLY_DATE_STR,
            A.PHOTO_URL,
            A.ANIMAL_NAME
		FROM ADOPTION_APPLICATIONS AP
        LEFT JOIN ANIMAL_DETAILS A ON AP.ANIMAL_NO = A.ANIMAL_NO
		WHERE AP.USER_ID = #{userId}
		ORDER BY 
			CASE
				WHEN AP.ADOPT_STATUS = 1 THEN 1
				WHEN AP.ADOPT_STATUS = 2 THEN 2
				ELSE 3
			END ASC,
			AP.APPLY_DT DESC
	</select>
	
	<!-- 유저가 신청한 입양 수 세기 -->
	<select id="selectAnimalList2Count" resultType="_int">
		SELECT COUNT(*)
		FROM ADOPTION_APPLICATIONS
		WHERE USER_ID = #{userId}
	</select>
	
	
	<!-- 입양 신청 번호로 입양 신청정보 리스트 조회 -->	  
	<select id="selectApplication" parameterType="_int" resultType="AdoptionApplicationVO">
	    SELECT 
	        ADOPTION_APP_ID,
	        ANIMAL_NO,
	        USER_ID,
	        ADOPT_STATUS,
	        APPLY_DT
	    FROM ADOPTION_APPLICATIONS
	    WHERE ADOPTION_APP_ID = #{adoptionAppId}
	    ORDER BY ADOPTION_STATUS
	</select>

	<!-- 입양 신청 번호로 해당 입양 신청취소(삭제) -->
	<delete id="deleteapp" parameterType="_int">
	    DELETE FROM ADOPTION_APPLICATIONS
	    WHERE ADOPTION_APP_ID = #{adoptionAppId}
	</delete>
	
	<!-- anino에 해당하는 동물등록상태 반려로 바꾸기 -->
	<update id="denyBoard" parameterType="_int">
		UPDATE ANIMAL_DETAILS
		SET ADOPTION_STATUS ='반려'
		WHERE ANIMAL_NO = #{anino}
	</update>
	
	<!-- 신청서 중복 체크 확인 -->
	<select id="checkApplication" parameterType="Map" resultType="_int">
		SELECT COUNT(*)
		FROM ADOPTION_APPLICATIONS
		WHERE ANIMAL_NO = #{animalNo}
		AND USER_ID = #{userId}
	</select>

	<!-- 관리자용 동물/게시글 전체 목록 가저오기 (검색/필터 적용) -->
	<select id="allList" resultType="AnimalDetail" parameterType="hashmap">
        SELECT A.*, P.POST_NO
        FROM ANIMAL_DETAILS A
        LEFT JOIN ADOPTION_POSTS P ON A.ANIMAL_NO = P.ANIMAL_NO
        <where>
        	<if test="animalNo != null and animalNo != ''">
        		AND A.ANIMAL_NO = #{animalNo}
        	</if>
        	<if test="onlyPending != null and onlyPending == 'true'">
        		AND P.POST_NO IS NULL
        		AND A.ADOPTION_STATUS != '반려'
        	</if>
        </where>
        ORDER BY A.ANIMAL_NO DESC
	</select>
	
	<!-- 관리자용 동물/게시글 전체 목록 갯수 (검색/필터 적용) -->
	<select id="managepostCount" resultType="_int" parameterType="hashmap">
		SELECT COUNT(*)
		FROM ANIMAL_DETAILS A
		LEFT JOIN ADOPTION_POSTS P ON A.ANIMAL_NO = P.ANIMAL_NO
		<where>
        	<if test="animalNo != null and animalNo != ''">
        		AND A.ANIMAL_NO = #{animalNo}
        	</if>
        	<if test="onlyPending != null and onlyPending == 'true'">
        		AND P.POST_NO IS NULL
        		AND A.ADOPTION_STATUS != '반려'
        	</if>
        </where>
	</select>

</mapper>