<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="volunteerMapper">

	<select id="selectActivityList" parameterType="hashmap" resultType="activity">
		SELECT
			ACT_ID,
			ADMIN_ID,
			ACT_TITLE,
			ACT_ADDRESS,
			ACT_DATE,
			ACT_END,
			ACT_CUR,
			ACT_MAX
		FROM ACTIVITIES
		WHERE 1=1
		<if test="condition == 'title'">
			AND ACT_TITLE LIKE '%' || #{keyword} || '%'
		</if>
		<if test="condition == 'address'">
			AND ACT_ADDRESS LIKE '%' || #{keyword} || '%'
		</if>
		ORDER BY ACT_ID DESC
	</select>

	<select id="selectReviewListAll" parameterType="hashmap" resultType="com.ubig.app.vo.volunteer.VolunteerReviewVO">
		SELECT R.*, A.ACT_TITLE, A.ACT_RATE
		FROM VOLUNTEER_REVIEWS R
		JOIN ACTIVITIES A ON R.ACT_ID = A.ACT_ID
		WHERE R.R_REMOVE = 0
		<if test="condition == 'title'">
			AND A.ACT_TITLE LIKE '%' || #{keyword} || '%'
		</if>
		<if test="condition == 'writer'">
			AND R.R_ID LIKE '%' || #{keyword} || '%'
		</if>
		<if test="condition == 'content'">
			AND R.R_REVIEW LIKE '%' || #{keyword} || '%'
		</if>
		ORDER BY R.REVIEW_NO DESC
	</select>

	<insert id="insertActivity" parameterType="activity">
		INSERT INTO ACTIVITIES (
			ACT_ID,
			ADMIN_ID,
			ACT_TITLE,
			ACT_ADDRESS,
			ACT_DATE,
			ACT_END,
			ACT_MAX,
			ACT_CUR,
			ACT_LAT,
			ACT_LON,
			ACT_LOAD,
			ACT_MONEY
		) VALUES (
			SEQ_ACTIVITIES.NEXTVAL,
			#{adminId},
			#{actTitle},
			#{actAddress},
			#{actDate},
			#{actEnd},
			#{actMax},
			0, 
			#{actLat},
			#{actLon},
			SYSDATE, 
			#{actMoney}
		)
	</insert>

	<select id="selectActivityOne" parameterType="int" resultType="activity">
		SELECT 
			A.ACT_ID,
			A.ADMIN_ID,
			A.ACT_TITLE,
			A.ACT_ADDRESS,
			A.ACT_DATE,
			A.ACT_END,
			A.ACT_MAX,
			(SELECT COUNT(*) FROM SIGNS S WHERE S.ACT_ID = A.ACT_ID AND S.SIGNS_STATUS = 1) AS ACT_CUR,
			A.ACT_LAT,
			A.ACT_LON,
			A.ACT_LOAD,
			A.ACT_MONEY
		FROM ACTIVITIES A
		WHERE ACT_ID = #{actId}
	</select>
	
	<delete id="deleteActivity" parameterType="int">
		DELETE FROM ACTIVITIES
		WHERE ACT_ID = #{actId}
	</delete>
	
	<update id="updateActivity" parameterType="activity">
		UPDATE ACTIVITIES
		SET ACT_TITLE = #{actTitle},
			ACT_ADDRESS = #{actAddress},
			ACT_DATE = #{actDate},
			ACT_END = #{actEnd},
			ACT_MAX = #{actMax}
		WHERE ACT_ID = #{actId}
	</update>

	<!-- 댓글 목록 조회 (후기 전용, REVIEW_NO 필수) -->
	<select id="selectReplyList" parameterType="com.ubig.app.vo.volunteer.VolunteerCommentVO" resultType="com.ubig.app.vo.volunteer.VolunteerCommentVO">
		SELECT *
		FROM VOLUNTEER_BOARD_COMMENTS
		WHERE ACT_ID = #{actId}
		AND CMT_REMOVE = 0
		AND REVIEW_NO = #{reviewNo}
		ORDER BY CMT_NO DESC
	</select>

	<!-- 댓글 등록 (후기 전용, REVIEW_NO 필수) -->
	<insert id="insertReply" parameterType="com.ubig.app.vo.volunteer.VolunteerCommentVO">
		INSERT INTO VOLUNTEER_BOARD_COMMENTS (
			CMT_NO, ACT_ID, USER_ID, CMT_ANSWER, CMT_DATE, CMT_UPDATE, CMT_REMOVE, CMT_RATE, REVIEW_NO
		) VALUES (
			SEQ_COMMENTS.NEXTVAL,
			#{actId},
			#{userId},
			#{cmtAnswer},
			SYSDATE,
			SYSDATE,
			0,
			#{cmtRate, jdbcType=INTEGER},
			#{reviewNo}
		)
	</insert>

	<update id="deleteReply" parameterType="_int">
		UPDATE VOLUNTEER_BOARD_COMMENTS
		SET CMT_REMOVE = 1
		WHERE CMT_NO = #{cmtNo}
	</update>
	
	<select id="selectCommentOne" parameterType="_int" resultType="com.ubig.app.vo.volunteer.VolunteerCommentVO">
		SELECT * FROM VOLUNTEER_BOARD_COMMENTS WHERE CMT_NO = #{cmtNo}
	</select>
	
	<select id="checkDuplicateSign" parameterType="com.ubig.app.vo.volunteer.SignVO" resultType="_int">
		SELECT COUNT(*)
		FROM SIGNS
		WHERE ACT_ID = #{actId}
		AND SIGNS_ID = #{signsId}
	</select>

	<insert id="insertSign" parameterType="com.ubig.app.vo.volunteer.SignVO">
		INSERT INTO SIGNS (
			SIGNS_NO, ACT_ID, SIGNS_ID, SIGNS_WAIT, SIGNS_STATUS, SIGNS_DATE
		) VALUES (
			SEQ_SIGNS.NEXTVAL,
			#{actId},
			#{signsId},
			1, 
			0,
			SYSDATE
		)
	</insert>

	<select id="selectSignList" parameterType="_int" resultType="com.ubig.app.vo.volunteer.SignVO">
		SELECT * FROM SIGNS
		WHERE ACT_ID = #{actId}
	</select>

	<!-- 봉사 신청 취소 (행 삭제) -->
	<delete id="deleteSign" parameterType="com.ubig.app.vo.volunteer.SignVO">
		DELETE FROM SIGNS
		WHERE ACT_ID = #{actId}
		AND SIGNS_ID = #{signsId}
	</delete>

	<!-- 봉사 신청 취소 시, 현재 인원 -1 감소 -->
	<update id="decreaseActivityCur" parameterType="_int">
		UPDATE ACTIVITIES
		SET ACT_CUR = ACT_CUR - 1
		WHERE ACT_ID = #{actId}
	</update>

	<insert id="insertReview" parameterType="com.ubig.app.vo.volunteer.VolunteerReviewVO">
		INSERT INTO VOLUNTEER_REVIEWS (
			REVIEW_NO, ACT_ID, R_ID, R_TITLE, R_REVIEW, R_RATE, R_CREATE, R_UPDATE, R_REMOVE
		) VALUES (
			SEQ_VOL_REVIEWS.NEXTVAL,
			#{actId},
			#{rId},
			#{rTitle},
			#{rReview},
			#{rRate},
			SYSDATE,
			SYSDATE,
			0
		)
	</insert>
	
	<select id="selectReviewList" parameterType="_int" resultType="com.ubig.app.vo.volunteer.VolunteerReviewVO">
		SELECT *
		FROM VOLUNTEER_REVIEWS
		WHERE ACT_ID = #{actId}
		AND R_REMOVE = 0
		ORDER BY REVIEW_NO DESC
	</select>

	<select id="selectReviewOne" parameterType="int" resultType="com.ubig.app.vo.volunteer.VolunteerReviewVO">
		SELECT R.*, A.ACT_TITLE, A.ACT_RATE
		FROM VOLUNTEER_REVIEWS R
		JOIN ACTIVITIES A ON R.ACT_ID = A.ACT_ID
		WHERE R.REVIEW_NO = #{reviewNo}
	</select>

	<update id="updateReview" parameterType="com.ubig.app.vo.volunteer.VolunteerReviewVO">
		UPDATE VOLUNTEER_REVIEWS
		SET R_TITLE = #{rTitle},
			R_REVIEW = #{rReview},
			R_RATE = #{rRate},
			R_UPDATE = SYSDATE
		WHERE REVIEW_NO = #{reviewNo}
	</update>

	<update id="deleteReview" parameterType="_int">
		UPDATE VOLUNTEER_REVIEWS
		SET R_REMOVE = 1
		WHERE REVIEW_NO = #{reviewNo}
	</update>
	
	<!-- 댓글 테이블(VOLUNTEER_BOARD_COMMENTS)만 바라보도록 쿼리를 단순화합니다.-->
	<update id="updateActivityRate" parameterType="_int">
	    UPDATE ACTIVITIES 
	    SET ACT_RATE = (
	        SELECT NVL(AVG(CMT_RATE), 0)
	        FROM VOLUNTEER_BOARD_COMMENTS
	        WHERE ACT_ID = #{actId}
	        AND CMT_REMOVE = 0
	        AND CMT_RATE > 0  )
	    WHERE ACT_ID = #{actId}
	</update>
	
	<!-- 봉사후기 중복 방지 메퍼 -->
	<select id="checkDuplicateReview" parameterType="_int" resultType="_int">
		SELECT COUNT(*)
		FROM VOLUNTEER_REVIEWS
		WHERE ACT_ID = #{actId}
		AND R_REMOVE = 0
	</select>
	
	
	<select id="selectActivityNoReview" resultType="activity">
        SELECT A.ACT_ID, A.ACT_TITLE, A.ACT_DATE
        FROM ACTIVITIES A
        WHERE NOT EXISTS (
            SELECT 1 
            FROM VOLUNTEER_REVIEWS R
            WHERE R.ACT_ID = A.ACT_ID 
            AND R.R_REMOVE = 0
        )
        ORDER BY A.ACT_DATE DESC
    </select>
    
    
    <update id="updateSignStatus" parameterType="com.ubig.app.vo.volunteer.SignVO">
		UPDATE SIGNS
		SET SIGNS_STATUS = #{signsStatus}
		WHERE SIGNS_NO = #{signsNo}
	</update>

	<update id="increaseActivityCur" parameterType="_int">
		UPDATE ACTIVITIES
		SET ACT_CUR = ACT_CUR + 1
		WHERE ACT_ID = #{actId}
	</update>

	<select id="selectSignOne" parameterType="_int" resultType="com.ubig.app.vo.volunteer.SignVO">
		SELECT * FROM SIGNS WHERE SIGNS_NO = #{signsNo}
	</select>
	
	

</mapper>