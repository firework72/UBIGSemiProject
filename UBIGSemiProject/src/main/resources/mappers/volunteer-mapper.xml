<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="volunteerMapper">



	<!-- 입력한 데이터들 조회하는 매퍼구 -->
	<select id="selectActivityList" parameterType="hashmap" resultType="activity">
		SELECT
		ACT_ID,
		ADMIN_ID,
		ACT_TITLE,
		ACT_ADDRESS,
		ACT_DATE,
		ACT_END,
		ACT_CUR,
		ACT_MAX
		FROM ACTIVITIES
		WHERE 1=1
		<if test="condition == 'title'">
			AND ACT_TITLE LIKE '%' || #{keyword} || '%'
		</if>
		<if test="condition == 'address'">
			AND ACT_ADDRESS LIKE '%' || #{keyword} || '%'
		</if>
		ORDER BY ACT_ID DESC
	</select>

    <!-- [추가 사유] 전체 후기 목록 조회 (ACTIVITIES 테이블과 조인) + 검색 기능 -->
    <select id="selectReviewListAll" parameterType="hashmap" resultType="com.ubig.app.vo.volunteer.VolunteerReviewVO">
        SELECT R.*, A.ACT_TITLE
        FROM VOLUNTEER_REVIEWS R
        JOIN ACTIVITIES A ON R.ACT_ID = A.ACT_ID
        WHERE R.R_REMOVE = 0
		<if test="condition == 'title'">
			AND A.ACT_TITLE LIKE '%' || #{keyword} || '%'
		</if>
		<if test="condition == 'writer'">
			AND R.R_ID LIKE '%' || #{keyword} || '%'
		</if>
		<if test="condition == 'content'">
			AND R.R_REVIEW LIKE '%' || #{keyword} || '%'
		</if>
        ORDER BY R.REVIEW_NO DESC
    </select>




	<!-- 데이터 입력 매퍼 -->
	<insert id="insertActivity" parameterType="activity">
		INSERT INTO ACTIVITIES (
		ACT_ID,
		ADMIN_ID,
		ACT_TITLE,
		ACT_ADDRESS,
		ACT_DATE,
		ACT_END,
		ACT_MAX,
		ACT_CUR,
		ACT_LAT,
		ACT_LON,
		ACT_LOAD,
		ACT_MONEY
		) VALUES (
		SEQ_ACTIVITIES.NEXTVAL,
		#{adminId},
		#{actTitle},
		#{actAddress},
		#{actDate},
		#{actEnd},
		#{actMax},
		0, -- 현재 인원은 처음엔 0명
		#{actLat},
		#{actLon},
		SYSDATE, -- 등록일은 현재 시간
		#{actMoney}
		)
	</insert>




	<!-- 활동 게시글 상세보기 페이지에 그 글의 정보를 꺼내오는 Sql구문  -->
	<select id="selectActivityOne" parameterType="int" resultType="activity">
		SELECT 
		    A.ACT_ID,
		    A.ADMIN_ID,
		    A.ACT_TITLE,
		    A.ACT_ADDRESS,
		    A.ACT_DATE,
		    A.ACT_END,
		    A.ACT_MAX,
		    -- [핵심] SIGNS 테이블에서 이 글(ACT_ID)에 신청한 사람 수를 세어서 ACT_CUR로 덮어씌움
		    (SELECT COUNT(*) FROM SIGNS S WHERE S.ACT_ID = A.ACT_ID) AS ACT_CUR,
		    A.ACT_LAT,
		    A.ACT_LON,
		    A.ACT_LOAD,
		    A.ACT_MONEY
		FROM ACTIVITIES A
		WHERE ACT_ID = #{actId}
	</select>
	
	
	<!-- 활동 게시글 삭제 구문 -->
	<delete id="deleteActivity" parameterType="int">
		DELETE FROM ACTIVITIES
		WHERE ACT_ID = #{actId}
	</delete>
	
	
	<!-- 활동 게시글 수정 테이블 구문 -->
	<update id="updateActivity" parameterType="activity">
		UPDATE ACTIVITIES
		SET ACT_TITLE = #{actTitle},
		    ACT_ADDRESS = #{actAddress},
		    ACT_DATE = #{actDate},
		    ACT_END = #{actEnd},
		    ACT_MAX = #{actMax}
		WHERE ACT_ID = #{actId}
	</update>
	
	


	<!-- [추가 사유] 특정 활동(actId)에 달린 유효한(삭제되지 않은) 댓글들을 최신순으로 가져오기 위함 -->
	<!-- 댓글 목록 조회 -->
    <select id="selectReplyList" parameterType="_int" resultType="com.ubig.app.vo.volunteer.VolunteerCommentVO">
        SELECT *
        FROM VOLUNTEER_BOARD_COMMENTS
        WHERE ACT_ID = #{actId}
        AND CMT_REMOVE = 0
        ORDER BY CMT_NO DESC
    </select>

    <!-- [추가 사유] 댓글 테이블(VOLUNTEER_BOARD_COMMENTS)에 새로운 댓글 데이터를 삽입하기 위함 -->
    <!-- 댓글 작성 -->
    <insert id="insertReply" parameterType="com.ubig.app.vo.volunteer.VolunteerCommentVO">
        INSERT INTO VOLUNTEER_BOARD_COMMENTS (
            CMT_NO, ACT_ID, USER_ID, CMT_ANSWER, CMT_DATE, CMT_UPDATE, CMT_REMOVE
        ) VALUES (
            SEQ_COMMENTS.NEXTVAL,
            #{actId},
            #{userId},
            #{cmtAnswer},
            SYSDATE,
            SYSDATE,
            0
        )
    </insert>

    <!-- [추가 사유] 댓글을 실제로 삭제하지 않고, 삭제 여부 컬럼(CMT_REMOVE)만 1로 변경하여 화면에서 숨기기 위함 (Soft Delete) -->
    <!-- 댓글 삭제 (상태값 변경) -->
    <update id="deleteReply" parameterType="_int">
        UPDATE VOLUNTEER_BOARD_COMMENTS
        SET CMT_REMOVE = 1
        WHERE CMT_NO = #{cmtNo}
    </update>
    
    <!-- 중복 체크  -->
    <select id="checkDuplicateSign" parameterType="com.ubig.app.vo.volunteer.SignVO" resultType="_int">
        SELECT COUNT(*)
        FROM SIGNS
        WHERE ACT_ID = #{actId}
        AND SIGNS_ID = #{signsId}
    </select>

    <!-- [추가 사유] 신청 테이블(SIGNS)에 회원의 신청 정보를 저장하여 참여 의사를 확정하기 위함 -->
    <!-- 봉사 신청 -->
    <insert id="insertSign" parameterType="com.ubig.app.vo.volunteer.SignVO">
        INSERT INTO SIGNS (
            SIGNS_NO, ACT_ID, SIGNS_ID, SIGNS_WAIT, SIGNS_STATUS, SIGNS_DATE
        ) VALUES (
            SEQ_SIGNS.NEXTVAL,
            #{actId},
            #{signsId},
            1, 
            0,
            SYSDATE
        )
    </insert>

    <!-- [추가 사유] 특정 활동에 신청한 모든 회원의 리스트를 관리자 페이지 등에서 확인하기 위함 -->
    <!-- 신청자 목록 조회 -->
    <select id="selectSignList" parameterType="_int" resultType="com.ubig.app.vo.volunteer.SignVO">
        SELECT * 
        FROM SIGNS
        WHERE ACT_ID = #{actId}
    </select>

    <!-- [추가 사유] 후기 테이블(VOLUNTEER_REVIEWS)에 사용자의 리뷰 텍스트와 평점 정보를 저장하기 위함 -->
    <!-- 후기 작성 -->
    <insert id="insertReview" parameterType="com.ubig.app.vo.volunteer.VolunteerReviewVO">
        INSERT INTO VOLUNTEER_REVIEWS (
            REVIEW_NO, ACT_ID, R_ID, R_REVIEW, R_RATE, R_CREATE, R_UPDATE, R_REMOVE
        ) VALUES (
            SEQ_VOL_REVIEWS.NEXTVAL,
			#{actId},
			#{rId},
			#{rReview},
			#{rRate},
			SYSDATE,
			SYSDATE,
			0
        )
    </insert>
    
    <!-- [추가 사유] 상세 페이지 하단에 다른 사람들이 남긴 후기를 보여주기 위해 조회함 -->
    <!-- 후기 목록 조회 (추가) -->
    <select id="selectReviewList" parameterType="_int" resultType="com.ubig.app.vo.volunteer.VolunteerReviewVO">
        SELECT *
        FROM VOLUNTEER_REVIEWS
        WHERE ACT_ID = #{actId}
        AND R_REMOVE = 0
        ORDER BY REVIEW_NO DESC
    </select>

   

    <!-- [추가 사유] 후기 상세 조회 (ACTIVITIES 테이블과 조인) -->
    <select id="selectReviewOne" parameterType="int" resultType="com.ubig.app.vo.volunteer.VolunteerReviewVO">
        SELECT R.*, A.ACT_TITLE
        FROM VOLUNTEER_REVIEWS R
        JOIN ACTIVITIES A ON R.ACT_ID = A.ACT_ID
        WHERE R.REVIEW_NO = #{reviewNo}
    </select>

    

    <!-- [추가 사유] 후기 수정 -->
    <update id="updateReview" parameterType="com.ubig.app.vo.volunteer.VolunteerReviewVO">
        UPDATE VOLUNTEER_REVIEWS
        SET R_REVIEW = #{rReview},
            R_RATE = #{rRate},
            R_UPDATE = SYSDATE
        WHERE REVIEW_NO = #{reviewNo}
    </update>

    <!-- [추가 사유] 후기 삭제 (Soft Delete) -->
    <update id="deleteReview" parameterType="_int">
        UPDATE VOLUNTEER_REVIEWS
        SET R_REMOVE = 1
        WHERE REVIEW_NO = #{reviewNo}
    </update>

</mapper>